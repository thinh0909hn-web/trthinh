<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Luxury Christmas Tree ‚Äî Slots</title>

  <style>
    :root{
      --bg:#050d1a;
      --gold:#d4af37;
      --gold2:#fceea7;
      --panel: rgba(10,10,10,0.62);
      --line: rgba(212,175,55,0.22);
      --shadow: rgba(0,0,0,0.55);
      --txt: rgba(252,238,167,0.92);
      --muted: rgba(212,175,55,0.62);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background: radial-gradient(circle at center, #0f2027 0%, #203a43 50%, #2c5364 100%);
      background-color: var(--bg);
      color: var(--txt);
      font-family: 'Times New Roman', serif;
      touch-action: manipulation;
    }
    #canvas-container{ position:absolute; inset:0; z-index:1; }

    /* LOADER */
    #loader{
      position:absolute; inset:0;
      background: var(--bg);
      z-index:200;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      transition: opacity .8s ease-out;
    }
    .spinner{
      width:46px; height:46px;
      border:1px solid rgba(212,175,55,0.22);
      border-top:1px solid rgba(212,175,55,1);
      border-radius:50%;
      animation: spin 1s linear infinite;
    }
    .loader-text{
      margin-top:18px;
      color: rgba(212,175,55,0.95);
      font-size:12px;
      letter-spacing:4px;
      text-transform:uppercase;
      opacity:.9;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* TOP HUD */
    #ui{
      position:absolute; inset:0;
      z-index:10;
      pointer-events:none;
    }
    #topbar{
      position:absolute;
      top: calc(env(safe-area-inset-top, 0px) + 10px);
      left: 12px;
      right: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }

    #title{
      pointer-events:none;
      margin:0;
      padding: 10px 12px;
      max-width: min(70vw, 740px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border-radius: 18px;
      border: 1px solid rgba(212,175,55,0.18);
      background: rgba(10,10,10,0.35);
      backdrop-filter: blur(10px);
      box-shadow: 0 22px 60px rgba(0,0,0,0.25);
      font-family: 'Cinzel', serif;
      font-weight:400;
      letter-spacing: 2px;
      font-size: clamp(18px, 4vw, 42px);
      background-image: linear-gradient(to bottom, #fff, #eebb66);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #controls{
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .icon-btn{
      width:46px; height:46px;
      border-radius:16px;
      border:1px solid rgba(212,175,55,0.45);
      background: rgba(20,20,20,0.55);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 55px rgba(0,0,0,0.35);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      display:grid; place-items:center;
      transition: .18s ease;
      color: rgba(212,175,55,0.96);
      user-select:none;
      font-size:18px;
    }
    .icon-btn:active{ transform: translateY(1px) scale(0.985); }

    .ham{
      width:18px; height:14px;
      position:relative;
    }
    .ham::before, .ham::after, .ham span{
      content:"";
      position:absolute; left:0; right:0;
      height:2px;
      background: rgba(212,175,55,0.95);
      border-radius:2px;
    }
    .ham::before{ top:0; }
    .ham span{ top:6px; }
    .ham::after{ top:12px; }

    /* TOAST */
    #toast{
      position:absolute;
      left: 12px;
      top: calc(env(safe-area-inset-top, 0px) + 76px);
      z-index:80;
      pointer-events:none;
      opacity:0;
      transform: translateY(-6px);
      transition: .22s ease;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(212,175,55,0.22);
      background: rgba(10,10,10,0.58);
      backdrop-filter: blur(12px);
      box-shadow: 0 22px 70px rgba(0,0,0,0.55);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(252,238,167,0.95);
      max-width: 90vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #toast.show{ opacity:1; transform: translateY(0); }

    /* MENU POPOVER */
    #menuBackdrop{
      position:absolute; inset:0;
      z-index:39;
      opacity:0;
      pointer-events:none;
      background: rgba(0,0,0,0.18);
      transition: opacity .18s ease;
    }
    #menuBackdrop.open{ opacity:1; pointer-events:auto; }

    #menu{
      position:absolute;
      top: calc(env(safe-area-inset-top, 0px) + 66px);
      right: 12px;
      width: min(360px, 92vw);
      z-index:40;
      border-radius: 20px;
      border: 1px solid rgba(212,175,55,0.22);
      background: rgba(10,10,10,0.62);
      backdrop-filter: blur(14px);
      box-shadow: 0 26px 90px rgba(0,0,0,0.6);
      padding: 10px;
      transform-origin: top right;
      transform: translateY(-6px) scale(0.97);
      opacity: 0;
      pointer-events: none;
      transition: .2s ease;
    }
    #menu.open{
      opacity:1;
      transform: translateY(0) scale(1);
      pointer-events:auto;
    }
    .menu-title{
      padding: 8px 10px 10px;
      color: rgba(252,238,167,0.95);
      font-family: 'Cinzel', serif;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      user-select:none;
    }
    .menu-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 0 2px 2px;
    }
    .btn{
      border: 1px solid rgba(212,175,55,0.18);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px 12px;
      color: rgba(212,175,55,0.95);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      transition: .18s ease;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:12px;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .btn:hover{ background: rgba(212,175,55,0.12); border-color: rgba(212,175,55,0.42); }
    .btn:active{ transform: translateY(1px); }
    .pill{
      font-size:10px;
      letter-spacing:1px;
      opacity:0.78;
      padding: 4px 8px;
      border-radius:999px;
      border: 1px solid rgba(212,175,55,0.22);
      background: rgba(0,0,0,0.12);
      text-transform:none;
      flex:0 0 auto;
    }
    .menu-hint{
      padding: 10px 10px 8px;
      color: rgba(212,175,55,0.60);
      font-size:10px;
      line-height:1.35;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    /* DRAWER */
    #drawerBackdrop{
      position:absolute; inset:0;
      z-index:54;
      opacity:0;
      pointer-events:none;
      background: rgba(0,0,0,0.28);
      transition: opacity .18s ease;
    }
    #drawerBackdrop.open{ opacity:1; pointer-events:auto; }

    #drawer{
      position:absolute;
      left: 12px;
      right: 12px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
      z-index:55;

      border-radius: 24px;
      border: 1px solid rgba(212,175,55,0.22);
      background: rgba(10,10,10,0.58);
      backdrop-filter: blur(14px);
      box-shadow: 0 26px 95px rgba(0,0,0,0.6);
      overflow:hidden;

      max-height: min(60vh, 640px);
      transform: translateY(18px);
      opacity:0;
      pointer-events:none;
      transition: .22s ease;
      display:flex;
      flex-direction:column;
    }
    #drawer.open{
      transform: translateY(0);
      opacity:1;
      pointer-events:auto;
    }
    .handle{
      position:absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 46px;
      height: 5px;
      border-radius: 999px;
      background: rgba(252,238,167,0.25);
      border: 1px solid rgba(212,175,55,0.12);
      pointer-events:none;
    }
    .drawer-head{
      padding: 16px 12px 10px;
      border-bottom: 1px solid rgba(212,175,55,0.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .drawer-title{
      font-family:'Cinzel', serif;
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(252,238,167,0.95);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 55vw;
      user-select:none;
    }
    .drawer-actions{
      display:flex;
      gap:8px;
      align-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .chip{
      border: 1px solid rgba(212,175,55,0.20);
      background: rgba(255,255,255,0.05);
      color: rgba(212,175,55,0.95);
      padding: 9px 10px;
      border-radius: 999px;
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .chip:active{ transform: translateY(1px); }
    .chip strong{
      font-size:10px;
      opacity:.8;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.16);
      background: rgba(0,0,0,0.14);
      letter-spacing:1px;
    }
    input[type="file"]{ display:none; }

    .drawer-body{
      flex: 1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .section{
      border: 1px solid rgba(212,175,55,0.14);
      background: rgba(255,255,255,0.03);
      border-radius: 18px;
      padding: 10px;
    }
    .section-title{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      color: rgba(212,175,55,0.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 10px;
      user-select:none;
      gap: 10px;
    }
    .small{
      color: rgba(212,175,55,0.65);
      font-size:10px;
      letter-spacing:0.8px;
      text-transform:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 55vw;
    }

    /* SLOTS GRID */
    #slots{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    @media (max-width:560px){
      #slots{ grid-template-columns: repeat(5, 1fr); }
    }
    .slot{
      aspect-ratio: 1/1;
      border-radius: 14px;
      border: 1px solid rgba(212,175,55,0.18);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
      overflow:hidden;
      cursor:pointer;
      position:relative;
      -webkit-tap-highlight-color:transparent;
    }
    .slot.selected{
      border-color: rgba(212,175,55,0.78);
      box-shadow: 0 0 0 2px rgba(212,175,55,0.18), inset 0 0 0 1px rgba(255,255,255,0.03);
    }
    .slot img{ width:100%; height:100%; object-fit:cover; display:block; }
    .slot .num{
      position:absolute; top:6px; left:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:10px;
      color: rgba(252,238,167,0.9);
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(212,175,55,0.18);
      padding: 2px 6px;
      border-radius: 999px;
    }
    .slot .state{
      position:absolute; right:6px; bottom:6px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:10px;
      letter-spacing:1px;
      text-transform:uppercase;
      color: rgba(212,175,55,0.88);
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(212,175,55,0.18);
      padding: 2px 6px;
      border-radius: 999px;
    }

    /* GALLERY */
    #gallery{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    @media (max-width:560px){
      #gallery{ grid-template-columns: repeat(5, 1fr); }
    }
    .thumb{
      aspect-ratio: 1/1;
      border-radius: 14px;
      overflow:hidden;
      cursor:pointer;
      border: 1px solid rgba(212,175,55,0.14);
      background: rgba(0,0,0,0.18);
      -webkit-tap-highlight-color:transparent;
      position:relative;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
    }
    .thumb:hover{ border-color: rgba(212,175,55,0.45); }

    #musicState{
      position:absolute;
      right: 12px;
      top: calc(env(safe-area-inset-top, 0px) + 76px);
      z-index:75;
      pointer-events:none;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,0.18);
      background: rgba(10,10,10,0.40);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.25);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: rgba(212,175,55,0.85);
      opacity:.95;
    }
    .hidden{ display:none !important; }
  </style>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <audio id="bgm" src="https://files.catbox.moe/7ibpf5.mp3" preload="auto" loop playsinline></audio>

  <div id="loader">
    <div class="spinner"></div>
    <div class="loader-text">Loading Luxury Tree</div>
  </div>

  <div id="canvas-container"></div>

  <div id="ui">
    <div id="topbar">
      <h1 id="title">Merry Christmas</h1>
      <div id="controls">
        <button class="icon-btn" id="btnDrawer" title="Photos">üñº</button>
        <button class="icon-btn" id="btnMenu" aria-label="Menu" title="Menu">
          <div class="ham"><span></span></div>
        </button>
      </div>
    </div>

    <div id="toast"></div>
    <div id="musicState">Music: LOADING‚Ä¶</div>
  </div>

  <div id="menuBackdrop"></div>
  <div id="menu">
    <div class="menu-title">Controls</div>
    <div class="menu-grid">
      <button class="btn" id="btnSnow"><span>Snow</span><span class="pill" id="snowState">ON</span></button>
      <button class="btn" id="btnReset"><span>Reset</span><span class="pill">R</span></button>
      <button class="btn" id="btnHideUI"><span>Hide UI</span><span class="pill">H</span></button>
      <button class="btn" id="btnShuffle"><span>Shuffle</span><span class="pill">‚áÑ</span></button>
    </div>
    <div class="menu-hint">
      Tap slot tr√™n c√¢y ƒë·ªÉ ch·ªçn, r·ªìi tap ·∫£nh trong Gallery ƒë·ªÉ thay. ·∫¢nh upload ƒë∆∞·ª£c t·ªëi ∆∞u n√©t 2K + mipmaps.
    </div>
  </div>

  <div id="drawerBackdrop"></div>
  <div id="drawer">
    <div class="handle"></div>
    <div class="drawer-head" id="drawerHead">
      <div class="drawer-title">Photos ‚Äî Replace Slots</div>
      <div class="drawer-actions">
        <label class="chip" title="Ch·ªçn ·∫£nh">
          Upload <strong id="countBadge">0</strong>
          <input type="file" id="fileInput" multiple accept="image/*" />
        </label>
        <button class="chip" id="btnClear" title="Clear slot">Clear<strong>DEL</strong></button>
        <button class="chip" id="btnClose" title="Close">Close<strong>‚úï</strong></button>
      </div>
    </div>

    <div class="drawer-body">
      <div class="section">
        <div class="section-title">
          <span>Slots (khung tr√™n c√¢y)</span>
          <span class="small" id="slotHint">Ch·ªçn 1 slot ƒë·ªÉ thay ·∫£nh</span>
        </div>
        <div id="slots"></div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>Gallery (·∫£nh ƒë√£ upload)</span>
          <span class="small">Tap ·∫£nh ƒë·ªÉ g√°n v√†o slot ƒëang ch·ªçn</span>
        </div>
        <div id="gallery"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

    // ===========================
    // CONFIG (hi-res upload)
    // ===========================
    const CONFIG = {
      colors: {
        bg: 0x050d1a,
        fog: 0x050d1a,
        champagneGold: 0xffd966,
        deepGreen: 0x03180a,
        accentRed: 0x990000,
      },
      tree: { height: 24, radius: 8 },
      camera: { z: 50 },
      ornaments: { count: 1500 },
      snow: { count: 1000 },
      slots: { count: 18, scale: 1.25, rOffset: 4.9, loops: 3.2 },
      garland: { loops: 7.6, radiusMul: 1.07, tubeRadius: 0.13 },
      lights: { count: 560, size: 0.23 },

      // ‚úÖ ch·∫•t l∆∞·ª£ng ·∫£nh upload
      image: {
        thumbSize: 320,         // gallery thumb
        texMax: 2048,           // texture 2K (auto h·∫° n·∫øu c·∫ßn)
        texMin: 1024            // fallback cho m√°y y·∫øu
      },

      preload: [
        'https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1200',
        'https://images.unsplash.com/photo-1576919228236-a097c32a5cd4?q=80&w=1200',
        'https://images.unsplash.com/photo-1512389142860-9c449e58a543?q=80&w=1200',
        'https://images.unsplash.com/photo-1482638588057-dce9509db949?q=80&w=1200'
      ]
    };

    const STATE = {
      snowOn: true,
      uiHidden: false,
      selectedSlot: -1,
      toastTimer: null,

      drawerDragging: false,
      drawerStartY: 0,
      drawerDY: 0,

      music: { ready:false, playing:false, unmuted:false }
    };

    // ===========================
    // DOM
    // ===========================
    const loaderEl = document.getElementById('loader');

    const btnMenu = document.getElementById('btnMenu');
    const btnDrawer = document.getElementById('btnDrawer');
    const menu = document.getElementById('menu');
    const menuBackdrop = document.getElementById('menuBackdrop');

    const drawer = document.getElementById('drawer');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const drawerHead = document.getElementById('drawerHead');

    const fileInput = document.getElementById('fileInput');
    const slotsEl = document.getElementById('slots');
    const galleryEl = document.getElementById('gallery');
    const slotHint = document.getElementById('slotHint');
    const countBadge = document.getElementById('countBadge');

    const snowState = document.getElementById('snowState');
    const toast = document.getElementById('toast');
    const musicState = document.getElementById('musicState');

    const btnSnow = document.getElementById('btnSnow');
    const btnReset = document.getElementById('btnReset');
    const btnHideUI = document.getElementById('btnHideUI');
    const btnShuffle = document.getElementById('btnShuffle');

    const btnClear = document.getElementById('btnClear');
    const btnClose = document.getElementById('btnClose');

    const bgm = document.getElementById('bgm');

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(STATE.toastTimer);
      STATE.toastTimer = setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    // ===========================
    // MUSIC (iOS autoplay policy)
    // ===========================
    async function startMusicMuted(){
      try{
        bgm.volume = 0.95;
        bgm.muted = true;
        await bgm.play();
        STATE.music.ready = true;
        STATE.music.playing = true;
        musicState.textContent = 'Music: READY (tap once for sound)';
      }catch(e){
        STATE.music.ready = false;
        musicState.textContent = 'Music: TAP TO START';
      }
    }

    async function unmuteMusicOnFirstGesture(){
      if (STATE.music.unmuted) return;
      try{
        if (bgm.paused) await bgm.play();
        bgm.muted = false;
        bgm.volume = 0.95;
        STATE.music.unmuted = true;
        STATE.music.playing = true;
        musicState.textContent = 'Music: PLAYING';
        setTimeout(()=>{ musicState.classList.add('hidden'); }, 1200);
      }catch(e){
        musicState.textContent = 'Music: TAP AGAIN';
      }
    }

    function bindGlobalGestureForMusic(){
      const handler = async () => {
        await unmuteMusicOnFirstGesture();
        if (STATE.music.unmuted){
          window.removeEventListener('pointerdown', handler, true);
          window.removeEventListener('touchstart', handler, true);
          window.removeEventListener('keydown', handler, true);
        }
      };
      window.addEventListener('pointerdown', handler, true);
      window.addEventListener('touchstart', handler, true);
      window.addEventListener('keydown', handler, true);
    }

    // ===========================
    // THREE
    // ===========================
    let scene, camera, renderer, composer;
    let mainGroup;
    const clock = new THREE.Clock();

    let snowSystem = null;
    let lightsMesh = null;
    let garlandMesh = null;

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();

    const slotMeshes = []; // { group, frame, photo, assignedId, isEmpty, uiEl }
    const slotTargets = [];

    const gallery = [];    // { id, dataUrl, thumbUrl, texture }
    let idCounter = 1;

    function initThree(){
      const container = document.getElementById('canvas-container');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(CONFIG.colors.bg);
      scene.fog = new THREE.FogExp2(CONFIG.colors.fog, 0.015);

      camera = new THREE.PerspectiveCamera(42, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, CONFIG.camera.z);

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:"high-performance" });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.toneMapping = THREE.ReinhardToneMapping;
      renderer.toneMappingExposure = 2.2;
      container.appendChild(renderer.domElement);

      mainGroup = new THREE.Group();
      scene.add(mainGroup);
    }

    function setupEnvironment(){
      const pmrem = new THREE.PMREMGenerator(renderer);
      scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
    }

    function setupLights(){
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));

      const inner = new THREE.PointLight(0xffaa00, 2.1, 24);
      inner.position.set(0, 5, 0);
      mainGroup.add(inner);

      const spotGold = new THREE.SpotLight(0xffcc66, 1200);
      spotGold.position.set(30, 40, 40);
      spotGold.angle = 0.5;
      spotGold.penumbra = 0.5;
      scene.add(spotGold);

      const spotBlue = new THREE.SpotLight(0x6688ff, 820);
      spotBlue.position.set(-30, 20, -30);
      scene.add(spotBlue);

      const fill = new THREE.DirectionalLight(0xffeebb, 0.9);
      fill.position.set(0, 0, 50);
      scene.add(fill);
    }

    function setupPost(){
      const renderPass = new RenderPass(scene, camera);
      const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
      bloom.threshold = 0.62;
      bloom.strength  = 0.7;
      bloom.radius    = 0.58;

      composer = new EffectComposer(renderer);
      composer.addPass(renderPass);
      composer.addPass(bloom);
    }

    function createSnow(){
      const geometry = new THREE.BufferGeometry();
      const vertices = [];
      const velocities = [];

      const c = document.createElement('canvas');
      c.width = 32; c.height = 32;
      const g = c.getContext('2d');
      g.fillStyle = 'white';
      g.beginPath();
      g.arc(16,16,16,0,Math.PI*2);
      g.fill();
      const snowTex = new THREE.CanvasTexture(c);

      for (let i=0;i<CONFIG.snow.count;i++){
        vertices.push(
          THREE.MathUtils.randFloatSpread(100),
          THREE.MathUtils.randFloatSpread(60),
          THREE.MathUtils.randFloatSpread(60)
        );
        velocities.push(Math.random()*0.2+0.1, Math.random()*0.05);
      }

      geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
      geometry.setAttribute('userData', new THREE.Float32BufferAttribute(velocities, 2));

      const mat = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.42,
        map: snowTex,
        transparent:true,
        opacity:0.8,
        blending:THREE.AdditiveBlending,
        depthWrite:false
      });

      snowSystem = new THREE.Points(geometry, mat);
      scene.add(snowSystem);
    }

    function updateSnow(){
      if (!snowSystem) return;
      snowSystem.visible = STATE.snowOn;
      if (!STATE.snowOn) return;

      const pos = snowSystem.geometry.attributes.position.array;
      const ud  = snowSystem.geometry.attributes.userData.array;

      for (let i=0;i<CONFIG.snow.count;i++){
        const fall = ud[i*2];
        pos[i*3+1] -= fall;

        const sway = ud[i*2+1];
        pos[i*3] += Math.sin(clock.elapsedTime*2 + i)*sway*0.1;

        if (pos[i*3+1] < -30){
          pos[i*3+1] = 30;
          pos[i*3]   = THREE.MathUtils.randFloatSpread(100);
          pos[i*3+2] = THREE.MathUtils.randFloatSpread(60);
        }
      }
      snowSystem.geometry.attributes.position.needsUpdate = true;
    }

    function createTreeOrnaments(){
      const sphereGeo = new THREE.SphereGeometry(0.5, 32, 32);
      const boxGeo    = new THREE.BoxGeometry(0.55, 0.55, 0.55);

      const goldMat = new THREE.MeshStandardMaterial({
        color: CONFIG.colors.champagneGold,
        metalness: 1.0,
        roughness: 0.1,
        envMapIntensity: 2.0,
        emissive: 0x443300,
        emissiveIntensity: 0.35
      });

      const greenMat = new THREE.MeshStandardMaterial({
        color: CONFIG.colors.deepGreen,
        metalness: 0.25,
        roughness: 0.85,
        emissive: 0x002200,
        emissiveIntensity: 0.22
      });

      const redMat = new THREE.MeshPhysicalMaterial({
        color: CONFIG.colors.accentRed,
        metalness: 0.35,
        roughness: 0.18,
        clearcoat: 1.0,
        emissive: 0x330000
      });

      for (let i=0;i<CONFIG.ornaments.count;i++){
        const t = Math.pow(Math.random(), 0.82);
        const y = t*CONFIG.tree.height - CONFIG.tree.height/2;

        let rMax = CONFIG.tree.radius*(1.0 - t);
        rMax = Math.max(rMax, 0.55);

        const angle = t*50*Math.PI + Math.random()*Math.PI;
        const r = rMax*(0.8 + Math.random()*0.45);

        const pick = Math.random();
        let mesh;
        if (pick < 0.45) mesh = new THREE.Mesh(boxGeo, greenMat);
        else if (pick < 0.82) mesh = new THREE.Mesh(boxGeo, goldMat);
        else if (pick < 0.94) mesh = new THREE.Mesh(sphereGeo, goldMat);
        else mesh = new THREE.Mesh(sphereGeo, redMat);

        const s = 0.36 + Math.random()*0.55;
        mesh.scale.set(s,s,s);
        mesh.position.set(Math.cos(angle)*r, y, Math.sin(angle)*r);
        mesh.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6);

        mainGroup.add(mesh);
      }

      // Star
      const starShape = new THREE.Shape();
      const points = 5, outerRadius = 1.55, innerRadius = 0.72;
      for (let i=0;i<points*2;i++){
        const a = (i*Math.PI)/points + Math.PI/2;
        const rr = (i%2===0)? outerRadius : innerRadius;
        const x = Math.cos(a)*rr;
        const y = Math.sin(a)*rr;
        if (i===0) starShape.moveTo(x,y);
        else starShape.lineTo(x,y);
      }
      starShape.closePath();

      const starGeo = new THREE.ExtrudeGeometry(starShape, {
        depth: 0.42,
        bevelEnabled:true,
        bevelThickness:0.1,
        bevelSize:0.1,
        bevelSegments:2
      });
      starGeo.center();

      const starMat = new THREE.MeshStandardMaterial({
        color: 0xffdd88,
        emissive: 0xffaa00,
        emissiveIntensity: 1.2,
        metalness:1.0,
        roughness:0
      });

      const star = new THREE.Mesh(starGeo, starMat);
      star.position.set(0, CONFIG.tree.height/2 + 1.35, 0);
      mainGroup.add(star);
    }

    function createFairyLights(){
      const count = CONFIG.lights.count;
      const pos = new Float32Array(count*3);
      const col = new Float32Array(count*3);

      const h = CONFIG.tree.height*0.98;
      const halfH = h/2;

      for (let i=0;i<count;i++){
        const t = i/(count-1);
        const y = t*h - halfH;

        let rMax = CONFIG.tree.radius*(1.0 - t);
        rMax = Math.max(rMax, 0.6);

        const loops = 10.8;
        const angle = t*Math.PI*2*loops;
        const r = rMax*1.02;

        pos[i*3+0] = Math.cos(angle)*r;
        pos[i*3+1] = y;
        pos[i*3+2] = Math.sin(angle)*r;

        const red = (i%7===0);
        col[i*3+0] = 1.0;
        col[i*3+1] = red ? 0.25 : 0.85;
        col[i*3+2] = red ? 0.18 : 0.35;
      }

      const geo = new THREE.BufferGeometry();
      geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
      geo.setAttribute('color', new THREE.BufferAttribute(col,3));

      const mat = new THREE.PointsMaterial({
        size: CONFIG.lights.size,
        vertexColors:true,
        transparent:true,
        opacity:0.95,
        blending:THREE.AdditiveBlending,
        depthWrite:false
      });

      lightsMesh = new THREE.Points(geo, mat);
      mainGroup.add(lightsMesh);
    }

    function updateFairyLights(dt){
      if (!lightsMesh) return;
      const t = clock.elapsedTime;
      lightsMesh.material.opacity = 0.72 + 0.22*Math.sin(t*2.2);
      lightsMesh.rotation.y += 0.12*dt;
    }

    function createGarland(){
      const h = CONFIG.tree.height*0.98;
      const halfH = h/2;

      const segments = 520;
      const points = [];
      for (let i=0;i<=segments;i++){
        const t = i/segments;
        const y = t*h - halfH;

        let rMax = CONFIG.tree.radius*(1.0 - t);
        rMax = Math.max(rMax, 0.65);

        const angle = t*Math.PI*2*CONFIG.garland.loops + Math.PI/6;
        const r = rMax * CONFIG.garland.radiusMul;

        points.push(new THREE.Vector3(Math.cos(angle)*r, y, Math.sin(angle)*r));
      }

      const path = new THREE.CatmullRomCurve3(points);
      const tubeGeo = new THREE.TubeGeometry(path, 900, CONFIG.garland.tubeRadius, 10, false);

      const mat = new THREE.MeshPhysicalMaterial({
        color: 0xffd37a,
        metalness: 1.0,
        roughness: 0.18,
        clearcoat: 1.0,
        clearcoatRoughness: 0.15,
        emissive: 0x553300,
        emissiveIntensity: 0.62
      });

      garlandMesh = new THREE.Mesh(tubeGeo, mat);
      garlandMesh.renderOrder = 2;
      mainGroup.add(garlandMesh);
    }

    function updateGarland(dt){
      if (!garlandMesh) return;
      const t = clock.elapsedTime;
      garlandMesh.material.emissiveIntensity = 0.55 + 0.25*Math.sin(t*2.6);
      garlandMesh.rotation.y += 0.05*dt;
    }

    // ===========================
    // SLOT SYSTEM (3D + UI)
    // ===========================
    function computeSlotTargets(){
      slotTargets.length = 0;
      const count = CONFIG.slots.count;

      const h = CONFIG.tree.height * 0.92;
      const bottomY = -h/2;
      const stepY = h / count;

      for (let i=0;i<count;i++){
        const y = bottomY + stepY*i + stepY/2;
        const fullH = CONFIG.tree.height;
        const nh = (y + fullH/2) / fullH;

        let rMax = CONFIG.tree.radius * (1.0 - nh);
        rMax = Math.max(rMax, 1.0);

        const r = rMax + CONFIG.slots.rOffset;
        const angle = nh*Math.PI*2*CONFIG.slots.loops + (Math.PI/4);

        slotTargets.push(new THREE.Vector3(Math.cos(angle)*r, y, Math.sin(angle)*r));
      }
    }

    function makeEmptyTexture(){
      const c = document.createElement('canvas');
      c.width = 512; c.height = 512;
      const g = c.getContext('2d');

      const grd = g.createLinearGradient(0,0,512,512);
      grd.addColorStop(0,'rgba(255,255,255,0.08)');
      grd.addColorStop(1,'rgba(0,0,0,0.22)');
      g.fillStyle = grd;
      g.fillRect(0,0,512,512);

      g.strokeStyle = 'rgba(212,175,55,0.45)';
      g.lineWidth = 10;
      g.strokeRect(22,22,468,468);

      g.fillStyle = 'rgba(252,238,167,0.9)';
      g.font = 'bold 40px Cinzel, serif';
      g.textAlign = 'center';
      g.fillText('TAP SLOT', 256, 250);

      g.fillStyle = 'rgba(212,175,55,0.70)';
      g.font = '24px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      g.fillText('to replace photo', 256, 300);

      const tex = new THREE.CanvasTexture(c);
      tex.colorSpace = THREE.SRGBColorSpace;
      return tex;
    }

    function createSlots3D(){
      computeSlotTargets();

      const frameMat = new THREE.MeshStandardMaterial({
        color: CONFIG.colors.champagneGold,
        metalness: 1.0,
        roughness: 0.12,
        emissive: 0x332200,
        emissiveIntensity: 0.28
      });

      for (let i=0;i<CONFIG.slots.count;i++){
        const group = new THREE.Group();
        group.userData.slotIndex = i;

        const frameGeo = new THREE.BoxGeometry(1.6, 1.6, 0.065);
        const frame = new THREE.Mesh(frameGeo, frameMat);
        frame.userData.slotIndex = i;

        const emptyTex = makeEmptyTexture();
        const photoGeo = new THREE.PlaneGeometry(1.48, 1.48);
        const photoMat = new THREE.MeshBasicMaterial({ map: emptyTex, side: THREE.DoubleSide });
        const photo = new THREE.Mesh(photoGeo, photoMat);
        photo.position.z = 0.048;
        photo.userData.slotIndex = i;

        group.add(frame);
        group.add(photo);

        const s = CONFIG.slots.scale;
        group.scale.set(s,s,s);

        group.position.copy(slotTargets[i]);
        group.lookAt(0, group.position.y, 0);
        group.rotateY(Math.PI);

        mainGroup.add(group);

        slotMeshes.push({
          group, frame, photo,
          assignedId: null,
          isEmpty: true,
          uiEl: null
        });
      }
    }

    function createEmptyThumbDataUrl(){
      const c = document.createElement('canvas');
      c.width = 240; c.height = 240;
      const g = c.getContext('2d');
      g.fillStyle = 'rgba(0,0,0,0.22)';
      g.fillRect(0,0,240,240);
      g.strokeStyle = 'rgba(212,175,55,0.42)';
      g.lineWidth = 7;
      g.strokeRect(16,16,208,208);
      g.fillStyle = 'rgba(252,238,167,0.88)';
      g.font = 'bold 18px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      g.textAlign = 'center';
      g.fillText('EMPTY', 120, 128);
      return c.toDataURL('image/png');
    }

    function buildSlotsUI(){
      slotsEl.innerHTML = '';
      for (let i=0;i<CONFIG.slots.count;i++){
        const div = document.createElement('div');
        div.className = 'slot';
        div.dataset.slot = String(i);

        const num = document.createElement('div');
        num.className = 'num';
        num.textContent = `#${i+1}`;

        const state = document.createElement('div');
        state.className = 'state';
        state.textContent = 'EMPTY';

        const img = document.createElement('img');
        img.alt = `slot-${i+1}`;
        img.src = createEmptyThumbDataUrl();

        div.appendChild(img);
        div.appendChild(num);
        div.appendChild(state);

        div.addEventListener('click', ()=>toggleSelectSlot(i));
        slotsEl.appendChild(div);

        slotMeshes[i].uiEl = div;
      }
      for (let i=0;i<CONFIG.slots.count;i++){
        updateSlotUI(i);
      }
    }

    function highlightSelected(){
      slotsEl.querySelectorAll('.slot').forEach(el=>{
        const idx = Number(el.dataset.slot);
        el.classList.toggle('selected', idx===STATE.selectedSlot);
      });
      for (let i=0;i<slotMeshes.length;i++){
        const sel = i===STATE.selectedSlot;
        const base = CONFIG.slots.scale;
        slotMeshes[i].group.scale.setScalar(base*(sel?1.08:1.0));
      }
    }

    function setSelectedSlot(i, source='ui'){
      STATE.selectedSlot = i;
      slotHint.textContent = `ƒêang ch·ªçn slot #${i+1} ‚Äî tap ·∫£nh trong Gallery ƒë·ªÉ thay`;
      highlightSelected();
      if (!drawer.classList.contains('open')) openDrawer();
      if (source==='3d') showToast(`ƒê√£ ch·ªçn slot #${i+1}`);
    }

    function toggleSelectSlot(i){
      if (STATE.selectedSlot===i){
        STATE.selectedSlot = -1;
        slotHint.textContent = 'Ch·ªçn 1 slot ƒë·ªÉ thay ·∫£nh';
      }else{
        setSelectedSlot(i,'ui');
      }
      highlightSelected();
    }

    function updateSlotUI(slotIndex){
      const ui = slotMeshes[slotIndex].uiEl;
      if (!ui) return;

      const img = ui.querySelector('img');
      const state = ui.querySelector('.state');

      const assignedId = slotMeshes[slotIndex].assignedId;
      if (!assignedId){
        img.src = createEmptyThumbDataUrl();
        state.textContent = 'EMPTY';
      }else{
        const item = gallery.find(x=>x.id===assignedId);
        img.src = item?.thumbUrl || createEmptyThumbDataUrl();
        state.textContent = 'SET';
      }
    }

    function applyTextureQuality(texture){
      // ‚úÖ FIX blur: mipmap + filters + anisotropy
      texture.colorSpace = THREE.SRGBColorSpace;
      texture.generateMipmaps = true;
      texture.minFilter = THREE.LinearMipmapLinearFilter;
      texture.magFilter = THREE.LinearFilter;
      texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
      texture.needsUpdate = true;
      return texture;
    }

    function setSlotTexture(slotIndex, texture, assignedId){
      const s = slotMeshes[slotIndex];
      if (!s) return;

      applyTextureQuality(texture);

      s.photo.material.map = texture;
      s.photo.material.needsUpdate = true;

      s.assignedId = assignedId ?? null;
      s.isEmpty = false;

      updateSlotUI(slotIndex);
    }

    function clearSlot(slotIndex){
      const s = slotMeshes[slotIndex];
      if (!s) return;

      const emptyTex = makeEmptyTexture();
      s.photo.material.map = emptyTex;
      s.photo.material.needsUpdate = true;

      s.assignedId = null;
      s.isEmpty = true;

      updateSlotUI(slotIndex);
    }

    function findNextEmptySlot(){
      for (let i=0;i<slotMeshes.length;i++){
        if (slotMeshes[i].isEmpty) return i;
      }
      return -1;
    }
    function findNextSlotAfter(cur){
      for (let i=cur+1;i<slotMeshes.length;i++){
        if (slotMeshes[i].isEmpty) return i;
      }
      for (let i=0;i<=cur;i++){
        if (slotMeshes[i].isEmpty) return i;
      }
      return (cur+1)%slotMeshes.length;
    }

    function renderGalleryUI(){
      galleryEl.innerHTML = '';
      countBadge.textContent = String(gallery.length);

      gallery.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'thumb';
        div.dataset.id = String(item.id);

        const img = document.createElement('img');
        img.src = item.thumbUrl;
        img.alt = `photo-${item.id}`;
        div.appendChild(img);

        div.addEventListener('click', ()=>{
          if (STATE.selectedSlot<0){
            const next = findNextEmptySlot();
            setSelectedSlot(next>=0 ? next : 0);
          }
          setSlotTexture(STATE.selectedSlot, item.texture, item.id);
          showToast(`ƒê√£ thay ·∫£nh slot #${STATE.selectedSlot+1}`);

          const next = findNextSlotAfter(STATE.selectedSlot);
          STATE.selectedSlot = next;
          slotHint.textContent = `ƒêang ch·ªçn slot #${next+1} ‚Äî tap ·∫£nh ƒë·ªÉ thay`;
          highlightSelected();
        });

        galleryEl.appendChild(div);
      });
    }

    // ===========================
    // HI-RES UPLOAD PIPELINE
    // ===========================
    async function fileToDataUrl(file){
      return await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function getSafeTexMax(){
      // ‚úÖ iOS/m√°y y·∫øu: h·∫° texMax ƒë·ªÉ tr√°nh crash
      const dpr = window.devicePixelRatio || 1;
      const mem = navigator.deviceMemory || 4; // chrome android supports, iOS often undefined
      const small = (mem && mem <= 2) || dpr >= 3;
      return small ? Math.max(CONFIG.image.texMin, 1536) : CONFIG.image.texMax;
    }

    async function makeThumb(dataUrl, size=CONFIG.image.thumbSize){
      const img = new Image();
      img.src = dataUrl;
      await img.decode();

      const c = document.createElement('canvas');
      c.width = size; c.height = size;
      const ctx = c.getContext('2d');

      // ‚úÖ HIGH quality thumbnail
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      const iw = img.width, ih = img.height;
      const scale = Math.max(size/iw, size/ih);
      const w = iw*scale, h = ih*scale;
      const x = (size-w)/2;
      const y = (size-h)/2;

      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.fillRect(0,0,size,size);
      ctx.drawImage(img, x, y, w, h);

      return c.toDataURL('image/jpeg', 0.88);
    }

    async function dataUrlToHiResTexture(dataUrl){
      // ‚úÖ CORE FIX: create 2K texture via canvas (not thumb)
      const img = new Image();
      img.src = dataUrl;
      await img.decode();

      const MAX = getSafeTexMax(); // 2048 or lower depending device
      const maxDim = Math.max(img.width, img.height);
      const scale = Math.min(1, MAX / maxDim);

      const w = Math.max(2, Math.floor(img.width * scale));
      const h = Math.max(2, Math.floor(img.height * scale));

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      ctx.drawImage(img, 0, 0, w, h);

      const texture = new THREE.CanvasTexture(canvas);
      return applyTextureQuality(texture);
    }

    async function addToGallery(dataUrl){
      const thumbUrl = await makeThumb(dataUrl);
      const texture = await dataUrlToHiResTexture(dataUrl);
      const item = { id:idCounter++, dataUrl, thumbUrl, texture };
      gallery.unshift(item);
      renderGalleryUI();
    }

    async function handleUpload(files){
      const arr = Array.from(files||[]).filter(f=>f.type.startsWith('image/'));
      if (!arr.length) return;

      showToast(`ƒêang n·∫°p ${arr.length} ·∫£nh (hi-res)...`);

      // ‚úÖ n·∫°p l·∫ßn l∆∞·ª£t ƒë·ªÉ tr√°nh spike b·ªô nh·ªõ
      for (const f of arr){
        try{
          const dataUrl = await fileToDataUrl(f);
          await addToGallery(dataUrl);
        }catch(e){
          console.warn('Upload fail:', e);
        }
      }
      showToast('Xong! Tap slot tr√™n c√¢y ƒë·ªÉ ch·ªçn khung');
    }

    async function fetchToDataUrl(url){
      const res = await fetch(url, { mode:'cors' });
      const blob = await res.blob();
      return await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(blob);
      });
    }

    async function preloadGallery(){
      for (const url of CONFIG.preload){
        try{
          const dataUrl = await fetchToDataUrl(url);
          await addToGallery(dataUrl);
        }catch(e){}
      }
    }

    // ===========================
    // UI OPEN/CLOSE
    // ===========================
    function openMenu(){ menu.classList.add('open'); menuBackdrop.classList.add('open'); }
    function closeMenu(){ menu.classList.remove('open'); menuBackdrop.classList.remove('open'); }
    function toggleMenu(){ menu.classList.contains('open') ? closeMenu() : openMenu(); }

    function openDrawer(){
      drawer.classList.add('open');
      drawerBackdrop.classList.add('open');
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      drawerBackdrop.classList.remove('open');
      drawer.style.transform = '';
      drawer.style.transition = '';
      STATE.drawerDY = 0;
    }
    function toggleDrawer(){ drawer.classList.contains('open') ? closeDrawer() : openDrawer(); }

    function resetView(){
      mainGroup.rotation.set(0,0,0);
      closeMenu();
    }

    function toggleUI(){
      STATE.uiHidden = !STATE.uiHidden;
      document.getElementById('ui').style.opacity = STATE.uiHidden ? '0' : '1';
      closeMenu();
    }

    function shuffleSlots(){
      const ids = slotMeshes.map(s=>s.assignedId).filter(Boolean);
      if (!ids.length){ showToast('Ch∆∞a c√≥ ·∫£nh ƒë·ªÉ shuffle'); return; }
      for (let i=ids.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [ids[i], ids[j]] = [ids[j], ids[i]];
      }
      let k = 0;
      for (let i=0;i<slotMeshes.length;i++){
        if (slotMeshes[i].assignedId){
          const id = ids[k++];
          const item = gallery.find(g=>g.id===id);
          if (item) setSlotTexture(i, item.texture, item.id);
        }
      }
      showToast('ƒê√£ shuffle slots');
      closeMenu();
    }

    function setupDrawerDrag(){
      const start = (y)=>{
        if (!drawer.classList.contains('open')) return;
        STATE.drawerDragging = true;
        STATE.drawerStartY = y;
        STATE.drawerDY = 0;
        drawer.style.transition = 'none';
      };
      const move = (y)=>{
        if (!STATE.drawerDragging) return;
        const dy = Math.max(0, y - STATE.drawerStartY);
        STATE.drawerDY = dy;
        drawer.style.transform = `translateY(${dy}px)`;
      };
      const end = ()=>{
        if (!STATE.drawerDragging) return;
        STATE.drawerDragging = false;
        drawer.style.transition = '0.18s ease';
        if (STATE.drawerDY > 90) closeDrawer();
        else drawer.style.transform = 'translateY(0px)';
      };

      drawerHead.addEventListener('touchstart', (e)=>start(e.touches[0].clientY), {passive:true});
      drawerHead.addEventListener('touchmove',  (e)=>move(e.touches[0].clientY), {passive:true});
      drawerHead.addEventListener('touchend', end, {passive:true});

      drawerHead.addEventListener('pointerdown', (e)=>start(e.clientY));
      window.addEventListener('pointermove', (e)=>move(e.clientY));
      window.addEventListener('pointerup', end);
    }

    function onCanvasPointerDown(e){
      if (menu.classList.contains('open')) return;

      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(pointer, camera);

      const clickables = [];
      for (const s of slotMeshes){
        clickables.push(s.photo);
        clickables.push(s.frame);
      }
      const hits = raycaster.intersectObjects(clickables, true);
      if (hits.length){
        const idx = hits[0].object.userData.slotIndex;
        if (typeof idx === 'number'){
          setSelectedSlot(idx, '3d');
          openDrawer();
        }
      }
    }

    // ===========================
    // EVENTS
    // ===========================
    function setupEvents(){
      window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
      });

      renderer.domElement.addEventListener('pointerdown', onCanvasPointerDown);

      btnMenu.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
      menuBackdrop.addEventListener('click', closeMenu);
      menu.addEventListener('click', (e)=>e.stopPropagation());

      btnDrawer.addEventListener('click', (e)=>{ e.stopPropagation(); toggleDrawer(); closeMenu(); });
      drawerBackdrop.addEventListener('click', closeDrawer);
      btnClose.addEventListener('click', closeDrawer);

      btnSnow.addEventListener('click', ()=>{
        STATE.snowOn = !STATE.snowOn;
        snowState.textContent = STATE.snowOn ? 'ON' : 'OFF';
      });
      btnReset.addEventListener('click', resetView);
      btnHideUI.addEventListener('click', toggleUI);
      btnShuffle.addEventListener('click', shuffleSlots);

      btnClear.addEventListener('click', ()=>{
        if (STATE.selectedSlot<0){
          showToast('Ch·ªçn slot tr∆∞·ªõc ƒë·ªÉ Clear');
          return;
        }
        clearSlot(STATE.selectedSlot);
        showToast(`ƒê√£ clear slot #${STATE.selectedSlot+1}`);
      });

      fileInput.addEventListener('change', async (e)=>{
        await handleUpload(e.target.files);
        e.target.value = '';
      });

      window.addEventListener('keydown', (e)=>{
        const k = e.key.toLowerCase();
        if (k==='escape'){ closeMenu(); closeDrawer(); }
        if (k==='h') toggleUI();
        if (k==='r') resetView();
      });

      setupDrawerDrag();
    }

    // ===========================
    // ANIMATE
    // ===========================
    function animate(){
      requestAnimationFrame(animate);
      const dt = clock.getDelta();

      mainGroup.rotation.y += 0.22*dt;
      mainGroup.rotation.x += (0 - mainGroup.rotation.x) * 1.8*dt;

      for (let i=0;i<slotMeshes.length;i++){
        const g = slotMeshes[i].group;
        g.rotation.z = 0.02*Math.sin(clock.elapsedTime*0.8 + i);
        g.rotation.x = 0.02*Math.cos(clock.elapsedTime*0.7 + i);
        g.lookAt(0, g.position.y, 0);
        g.rotateY(Math.PI);
      }

      updateFairyLights(dt);
      updateGarland(dt);
      updateSnow();

      composer.render();
    }

    // ===========================
    // INIT
    // ===========================
    async function init(){
      initThree();
      setupEnvironment();
      setupLights();

      createTreeOrnaments();
      createFairyLights();
      createGarland();
      createSnow();
      createSlots3D();

      setupPost();
      setupEvents();

      buildSlotsUI();
      await preloadGallery();
      renderGalleryUI();

      loaderEl.style.opacity = 0;
      setTimeout(()=>loaderEl.remove(), 800);

      // music
      bindGlobalGestureForMusic();
      await (async ()=>{
        try{
          bgm.volume = 0.95;
          bgm.muted = true;
          await bgm.play();
          musicState.textContent = 'Music: READY (tap once for sound)';
        }catch(e){
          musicState.textContent = 'Music: TAP TO START';
        }
      })();

      animate();
    }

    // Menu buttons
    document.getElementById('btnSnow').addEventListener('click', ()=>{});
    document.getElementById('btnReset').addEventListener('click', ()=>{});
    document.getElementById('btnHideUI').addEventListener('click', ()=>{});
    document.getElementById('btnShuffle').addEventListener('click', ()=>{});

    // connect menu actions after init uses functions
    document.getElementById('btnMenu').addEventListener('click', ()=>{});
    document.getElementById('btnDrawer').addEventListener('click', ()=>{});

    // Start
    init();
  </script>

  <script>
    // Hook menu actions (outside module due to scope isolation is not needed; kept in module already.)
  </script>
</body>
</html>
